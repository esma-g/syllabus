<!DOCTYPE html>




<html lang="en-gb">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>CYF&#43;</title>
    <meta name="description" content="A free and open source immersive engineering programme. Practical, hands on projects in Go, distributed systems engineering, site reliability engineering, software engineering. Pace, scale, and complexity." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        animation: fade-in 0.2s;
      }
      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
     
    <link
      rel="stylesheet"
      href="/bundled.min.f44ec27dd539fe9647de9751483e4bcd.css"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link rel="stylesheet" href="/bundled.min.f44ec27dd539fe9647de9751483e4bcd.css" />
    </noscript>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@300;400;700&family=Major+Mono+Display&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="/favicons/site.webmanifest" />
    <link rel="shortcut icon" href="/favicons/favicon.ico" />
    <meta name="apple-mobile-web-app-title" content="CYF+" />
    <meta name="application-name" content="CYF+" />
    <meta name="msapplication-TileColor" content="#9f00a7" />
    <meta
      name="msapplication-config"
      content="/favicons/browserconfig.xml"
    />
    <meta name="theme-color" content="#00ff90" />
  </head>
</html>
<body class="is-light-mode">
  <a class="c-skip-link e-button" id="skip-link" href="#main">Skip to main</a>
  <div class="l-layout">
    <header class="l-layout__header l-header">
  <div class="l-header__nav">
    <h1 class="l-header__heading">
      <a class="l-header__home" href="/">CYF&#43;</a>
    </h1>

    <button
      class="l-header__action e-button e-button--icon js-menu-toggle is-fixed"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon l-header__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z"
        />
      </svg>

      <span class="is-invisible">Open Menu.</span>
    </button>
  </div>
</header>
 <nav
  class="l-layout__menu l-menu"
  aria-label="Main Site Links."
  id="site-menu"
  hidden
  tabindex="0"
>
  <div class="l-menu__container">
    <h2 class="l-menu__heading e-heading__2">
      <a href="/" class="l-menu__home">CYF&#43;</a>
    </h2>
    <button
      class="l-menu__action e-button e-button--icon js-menu-toggle"
      id="close-menu"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>

      <span class="is-invisible">Close Menu.</span>
    </button>
    <ul class="l-menu__primary e-list">
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/about">About</a>
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/versions"
          >Versions</a
        >
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/projects"
          >Projects</a
        >
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/primers">Primers</a>
      </li>
    </ul>

    <div class="l-menu__secondary">
      
      <a class="l-menu__link e-link" href="#skip-link">
        <span class="is-invisible">To top</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          width="48px"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="l-menu__icon"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12"
          />
        </svg>
      </a>
      
    </div>
  </div>

  <img
    src="/pictures/depths/dddepth--005.webp"
    alt=""
    class="l-menu__bg"
  />
</nav>

    <main id="main" class="l-layout__main l-main" tabindex="0">
      

<article>
  <header class="l-page__header c-page-header">
    <div class="c-page-header__container">
      <div class="c-page-header__breadcrumbs">
        
<nav class="c-breadcrumbs">
  <ol class="c-breadcrumbs__list">
    <li class="c-breadcrumbs__item">
      <a class="c-breadcrumbs__link" href="/projects/">Projects</a>
    </li>
  </ol>
</nav>


      </div>
      <h1
        class="c-page-header__title e-heading__1 is-invisible"
      >
        GRPC Client and Server Communication
      </h1>
         
      <a
        class="c-page-header__edit e-heading__5 e-link is-none--lt-container"
        href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/projects/grpc-client-server/README.md"
        >Edit on Github</a
      >
       

  

  


<h2 class="c-lastmod c-page-header__lastmod">
  .Lastmod
  <a href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/grpc-client-server">
    <time datetime="2023-01-08T15:59:51Z">2023-01-08T15:59:51Z</time>
  </a>
</h2>

  
      <section class="c-page-header__toc c-toc" id="toc">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#learning-objectives">Learning objectives:</a></li>
    <li><a href="#what-is-grpc">What is gRPC?</a></li>
    <li><a href="#run-the-grpc-quick-start-hello-world-example">Run the gRPC Quick Start Hello World Example</a></li>
    <li><a href="#build-a-grpc-based-prober">Build a gRPC based prober</a></li>
    <li><a href="#implement-prober-logic">Implement prober logic</a></li>
    <li><a href="#add-a-client-timeout">Add a client timeout</a></li>
    <li><a href="#handling-errors">Handling Errors</a></li>
    <li><a href="#extra-challenge-serve-and-collect-prometheus-metrics">Extra Challenge: Serve and Collect Prometheus Metrics</a>
      <ol>
        <li><a href="#part-1-add-prometheus-metrics">Part 1: Add Prometheus Metrics</a></li>
        <li><a href="#part-2-scrape-prometheus-metrics">Part 2: Scrape Prometheus Metrics</a></li>
      </ol>
    </li>
  </ol>
</nav>
      </section>
      
    </div>
  </header>

  <section class="l-page__main c-copy"><p>Timebox: 3 days</p>
<h2 id="learning-objectives">Learning objectives:</h2>
<ul>
<li>Learn what gRPC is and how it differs from HTTP</li>
<li>Understand what kinds of issues can occur in a real system and how to defend against them</li>
<li>Learn what observability is, and what are some kinds of observability you&rsquo;d find in use in production?</li>
</ul>
<h2 id="what-is-grpc">What is gRPC?</h2>
<p>We&rsquo;ve used simple HTTP request so far, making and handling GET and POST requests.</p>
<p>RPC is another way to communicate between clients and servers (or frontends and backends).</p>
<p>It is used commonly within an organisation (it isn&rsquo;t used from browsers), where it has advantages around types, performance, and streaming.</p>
<p>gRPC is not used to communicate from web browsers to servers (important because this is context they have).</p>
<p>RPCs let you call a specific function on another computer. RPCs are highly structured; normally the request and response are encoded in efficient binary formats which are not human-readable. HTTP APIs are usually limited to CRUD (Create, Read, Update, Delete) operations and RPCs can perform any kind of operation.</p>
<p>If you want to efficiently integrate two systems that you control, RPCs are a good choice. If you want to provide an API for use by developers outside of your organisation then HTTP APIs are generally a better choice, because they are simpler to develop against, all programming languages provide good HTTP support, and HTTP works in the browser.</p>
<p>gRPC, which we will use in this exercise, is a RPC implementation that is fairly common in industry.</p>
<p>Read the <a href="https://grpc.io/docs/what-is-grpc/introduction/">gRPC Introduction</a> and
<a href="https://grpc.io/docs/what-is-grpc/core-concepts/">gRPC Core Concepts</a> for an overview of gRPC.</p>
<h2 id="run-the-grpc-quick-start-hello-world-example">Run the gRPC Quick Start Hello World Example</h2>
<p>Run through the <a href="https://grpc.io/docs/languages/go/quickstart/">gRPC Hello World example</a> from the grpc.io documentation.</p>
<p>This will ensure you have the right tools on your machine and working correctly.</p>
<h2 id="build-a-grpc-based-prober">Build a gRPC based prober</h2>
<p>Next, we will implement a simple prober service. Imagine that we want to verify that our site is available and has acceptable latency from many different locations around the world. We build a program that performs HTTP GETs on a provided endpoint and returns statistics about how long it took.</p>
<p>In a real production system, we could run several instances of our prober server in different regions and use one client to query all of the prober servers.</p>
<p>In the same directory as this README you will find initial versions of:</p>
<ul>
<li>the protocol buffer definition</li>
<li>prober server Go code</li>
<li>prober client Go code</li>
</ul>
<p>Generate the generated protobuf code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>&gt; protoc --go_out<span style="color:#f92672">=</span>. --go_opt<span style="color:#f92672">=</span>paths<span style="color:#f92672">=</span>source_relative <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
</span></span><span style="display:flex;"><span>    prober/prober.proto
</span></span></code></pre></div><p>Observe the new generated files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>&gt; ls prober
</span></span><span style="display:flex;"><span>&gt; prober.pb.go		prober.proto		prober_grpc.pb.go
</span></span></code></pre></div><p>Read through <code>prober_grpc.pb.go</code> - this is the interface we will use in our code. This is how gRPC works: a <code>proto</code> format
gets generated into language-specific code that we can use to interact with gRPCs. If we&rsquo;re working with multiple programming languages
that need to interact through RPCs, we can do this by generating from the same protocol buffer definition with the language-specific
tooling.</p>
<p>Now run the server and client code. You should see output like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>&gt; go run prober_server/main.go
</span></span><span style="display:flex;"><span>&gt; 2022/10/19 17:51:32 server listening at <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:50051
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>&gt; go run prober_client/main.go
</span></span><span style="display:flex;"><span>&gt; 2022/10/19 17:52:15 Response Time: 117.000000
</span></span></code></pre></div><p>We&rsquo;ve now gained some experience with the protocol buffer format, learned
how to generate Go code from protocol buffer definitions, and called that code from Go programs.</p>
<h2 id="implement-prober-logic">Implement prober logic</h2>
<p>Let&rsquo;s modify the prober service slightly. Instead of the simple one-off HTTP GET against a hardcoded google.com, we are going to modify the service to probe an HTTP endpoint N times and return the average time to GET that endpoint to the client.</p>
<p>Change your prober request and response:</p>
<ul>
<li>Add a field to the <code>ProbeRequest</code> for the number of requests to make.</li>
<li>Rename the field in <code>ProbeReply</code> (and perhaps add a comment) to make clear it&rsquo;s the <em>average</em> response time of the several requests.</li>
</ul>
<p>Note that it&rsquo;s ok to rename fields in protobuf (unlike when we use JSON), because the binary encoding of protobuf messages doesn&rsquo;t include field names.
However, do note that we need to be very careful about removing proto fields, changing their types, or changing the numerical ordering of fields. In general, these kinds of changes will break your clients because they change the binary encoding format.
You can <a href="https://earthly.dev/blog/backward-and-forward-compatibility/">read more about backward/forward compatibility with protobufs</a> if you want.</p>
<p>Remember that you&rsquo;ll need to re-generate your Go code after changing your proto definitions.</p>
<p>Update your client to read the endpoint and number of repetitions from the <a href="https://gobyexample.com/command-line-arguments">command line</a>.
Then update your server to execute the probe: do a HTTP fetch of <code>endpoint</code> the specified number of times.
The initial version of the code demonstrates how to use the standard <a href="https://pkg.go.dev/net/http"><code>net/http</code> package</a> and the standard time package.</p>
<p>Add up all the elapsed times, divide by the number of repetitions, and return the average to the client.
The client should print out the average value received.
You can do arithmetic operations like addition and division on <code>time.Duration</code> values in Go.</p>
<h2 id="add-a-client-timeout">Add a client timeout</h2>
<p>Maybe the site we are probing is very slow (which can happen for all kinds of reasons, from network problems to excessive load),
or perhaps the number of repetitions is very high.
Either way, we never want our program to wait forever.
If we are not careful about preventing this then we can end up building systems where problems in one small part of the system
spread across all of the services that talk to that part of the system.</p>
<p>On the client side, add a <a href="https://pkg.go.dev/context#WithTimeout">timeout</a> to stop waiting after 1 second.</p>
<p>Run your client against some website - how many repetitions do you need to see your client timeout?</p>
<h2 id="handling-errors">Handling Errors</h2>
<p>How do we know if the HTTP fetch succeeded at the server? Add a check to make sure it did.</p>
<p>How should we deal with errors, e.g. if the endpoint isn&rsquo;t found, or says the server is in an error state?
Modify your code and proto format to handle these cases.</p>
<h2 id="extra-challenge-serve-and-collect-prometheus-metrics">Extra Challenge: Serve and Collect Prometheus Metrics</h2>
<p>These sections are optional - do them for an extra challenge if time permits.</p>
<h3 id="part-1-add-prometheus-metrics">Part 1: Add Prometheus Metrics</h3>
<p>Let&rsquo;s learn something about how to monitor applications.</p>
<p>In software operations, we want to know what our software is doing and how it is performing.
One very useful technique is to have our program export metrics. Metrics are basically values that your
program makes available (the industry standard is to export and scrape over HTTP).</p>
<p>Specialised programs, such as Prometheus, can then fetch metrics regularly
from all the running instances of your program, store the history of these metrics, and do useful arithmetic on them
(like computing rates, averages, and maximums). We can use this data to do troubleshooting and to alert if things
go wrong.</p>
<p>Read the <a href="https://prometheus.io/docs/introduction/overview/">Overview of Prometheus</a>.</p>
<p>Now add Prometheus metrics to your prober server. Every time you execute a probe, update a <code>gauge</code> metric that tracks the latency.
Add a <code>label</code> specifying the endpoint being probed.
The <a href="https://prometheus.io/docs/guides/go-application/">Prometheus Guide to Instrumenting a Go Application</a> has all the information you need to do this.</p>
<p>Once you&rsquo;ve run your program, use your client to execute probes against some endpoint.
Now use the <code>curl</code> program or your browser to view the metrics.
You should see a number of built-in Go metrics, plus your new gauge.</p>
<p>If you use your client to start probing a second endpoint, you should see a second labelled metric appear.</p>
<h3 id="part-2-scrape-prometheus-metrics">Part 2: Scrape Prometheus Metrics</h3>
<p>The final step is to set up the Prometheus application to periodically pull metrics from your <code>prober_server</code>.</p>
<p>The easiest way to run Prometheus locally is in Docker. This way we can run an up-to-date version that has been built by the Prometheus maintainers.
See <a href="https://prometheus.io/docs/prometheus/latest/installation/">Prometheus Installation</a>.</p>
<p>You&rsquo;ll need to set up a simple configuration to scrape your <code>prober_server</code>. Prometheus <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">configuration</a> is quite complex but you can adapt this <a href="https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus.yml">example configuration</a>.</p>
<p>Next, find your custom gauge metric from your <code>prober_server</code> in http://localhost:9090/metrics.
Graph it in http://localhost:9090/graph.</p>
</section>

  
<footer class="c-page-footer c-copy">
  <h4 class="c-page-footer__section">
    <a
      class="c-page-footer__section-link e-link"
      href="/projects"
      >projects</a
    >
  </h4>
   
  <nav class="c-page-footer__section-nav">
    <a
      class="e-button e-button--icon c-page-footer__edit"
      href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/projects/grpc-client-server/README.md"
      ><svg
        role="presentation"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125"
        />
      </svg>
      <span class="is-invisible">Edit this page on GitHub</span></a
    >
    
    
  </nav>
</footer>


</article>


    </main><footer class="l-layout__footer l-footer">
  <a
    class="l-footer__github e-button e-button--icon"
    href="https://github.com/CodeYourFuture/immersive-go-course/"
  >
    <svg
      focusable="false"
      class="e-button__icon"
      role="presentation"
      viewbox="0 0 98 96"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"
        fill="currentColor"
      />
    </svg>
    <span class="is-invisible">Find us on GitHub</span>
  </a>
  <p class="l-footer__impressum e-heading__6">
    This
    <a href="https://github.com/CodeYourFuture/immersive-go-course/"
      >free and open source engineering programme</a
    >
    is a project of
    <a href="https://codeyourfuture.io">Code Your Future</a>
    <br />
    This work is licensed under a Creative Commons Attribution-ShareAlike 4.0
    International License.
  </p>
  <button
    id="mode-toggle"
    class="e__button--toggle e-button--icon l-footer__mode"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="e-icon e__button__icon e-icon--moon"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
      />
    </svg>

    <span class="is-invisible">Toggle between light and dark mode</span>
  </button>
</footer>

  

<script>
  function randomBG() {
    const style = document.createElement("style");
    style.textContent = `body, html {background-image:url("\/pictures/svgs/neons/nnneon.svg"),url("\/pictures/svgs/quads/qqquad-5.svg"),radial-gradient(circle,var(--theme-color--paper) 0%,var(--theme-color--block) 50%,var(--theme-color--paper) 100%);
      background-size: cover;
    }`;

    document.head.appendChild(style);
  }

  window.addEventListener("load", randomBG);
</script>


<script src="/scripts/app.min.js" defer></script>


</div>
</body>
