<!DOCTYPE html>




<html lang="en-gb">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>CYF&#43;</title>
    <meta name="description" content="A free and open source immersive engineering programme. Practical, hands on projects in Go, distributed systems engineering, site reliability engineering, software engineering. Pace, scale, and complexity." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        animation: fade-in 0.2s;
      }
      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
     
    <link
      rel="stylesheet"
      href="/bundled.min.f44ec27dd539fe9647de9751483e4bcd.css"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link rel="stylesheet" href="/bundled.min.f44ec27dd539fe9647de9751483e4bcd.css" />
    </noscript>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@300;400;700&family=Major+Mono+Display&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="/favicons/site.webmanifest" />
    <link rel="shortcut icon" href="/favicons/favicon.ico" />
    <meta name="apple-mobile-web-app-title" content="CYF+" />
    <meta name="application-name" content="CYF+" />
    <meta name="msapplication-TileColor" content="#9f00a7" />
    <meta
      name="msapplication-config"
      content="/favicons/browserconfig.xml"
    />
    <meta name="theme-color" content="#00ff90" />
  </head>
</html>
<body class="is-light-mode">
  <a class="c-skip-link e-button" id="skip-link" href="#main">Skip to main</a>
  <div class="l-layout">
    <header class="l-layout__header l-header">
  <div class="l-header__nav">
    <h1 class="l-header__heading">
      <a class="l-header__home" href="/">CYF&#43;</a>
    </h1>

    <button
      class="l-header__action e-button e-button--icon js-menu-toggle is-fixed"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon l-header__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z"
        />
      </svg>

      <span class="is-invisible">Open Menu.</span>
    </button>
  </div>
</header>
 <nav
  class="l-layout__menu l-menu"
  aria-label="Main Site Links."
  id="site-menu"
  hidden
  tabindex="0"
>
  <div class="l-menu__container">
    <h2 class="l-menu__heading e-heading__2">
      <a href="/" class="l-menu__home">CYF&#43;</a>
    </h2>
    <button
      class="l-menu__action e-button e-button--icon js-menu-toggle"
      id="close-menu"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>

      <span class="is-invisible">Close Menu.</span>
    </button>
    <ul class="l-menu__primary e-list">
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/about">About</a>
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/versions"
          >Versions</a
        >
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/projects"
          >Projects</a
        >
      </li>
      <li class="l-menu__item e-list__item">
        <a class="l-menu__link e-link e-heading__1" href="/primers">Primers</a>
      </li>
    </ul>

    <div class="l-menu__secondary">
      
      <a class="l-menu__link e-link" href="#skip-link">
        <span class="is-invisible">To top</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          width="48px"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="l-menu__icon"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12"
          />
        </svg>
      </a>
      
    </div>
  </div>

  <img
    src="/pictures/depths/dddepth--005.webp"
    alt=""
    class="l-menu__bg"
  />
</nav>

    <main id="main" class="l-layout__main l-main" tabindex="0">
      

<article>
  <header class="l-page__header c-page-header">
    <div class="c-page-header__container">
      <div class="c-page-header__breadcrumbs">
        
<nav class="c-breadcrumbs">
  <ol class="c-breadcrumbs__list">
    <li class="c-breadcrumbs__item">
      <a class="c-breadcrumbs__link" href="/projects/">Projects</a>
    </li>
  </ol>
</nav>


      </div>
      <h1
        class="c-page-header__title e-heading__1 is-invisible"
      >
        Servers &amp; HTTP requests
      </h1>
         
      <a
        class="c-page-header__edit e-heading__5 e-link is-none--lt-container"
        href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/projects/http-auth/README.md"
        >Edit on Github</a
      >
       

  

  


<h2 class="c-lastmod c-page-header__lastmod">
  .Lastmod
  <a href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/http-auth">
    <time datetime="2023-01-08T15:59:51Z">2023-01-08T15:59:51Z</time>
  </a>
</h2>

  
      <section class="c-page-header__toc c-toc" id="toc">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#learning-objectives">Learning objectives:</a></li>
    <li><a href="#project">Project</a>
      <ol>
        <li><a href="#making-an-http-server">Making an HTTP server</a></li>
        <li><a href="#status-codes">Status codes</a></li>
        <li><a href="#the-content-type-header">The Content-Type header</a></li>
        <li><a href="#methods-get-and-post">Methods: GET and POST</a></li>
        <li><a href="#query-parameters">Query parameters</a></li>
        <li><a href="#authentication">Authentication</a></li>
        <li><a href="#handling-load">Handling load</a></li>
      </ol>
    </li>
  </ol>
</nav>
      </section>
      
    </div>
  </header>

  <section class="l-page__main c-copy"><p>In this project we are going to learn about long-lived processes, some networking and the fundamentals of HTTP.</p>
<p>Timebox: 6 days</p>
<h2 id="learning-objectives">Learning objectives:</h2>
<ul>
<li>Use Go&rsquo;s net/http package to build start a simple server that responds to local requests</li>
<li>Get to know HTTP GET and response codes</li>
<li>Get familiar with cURL</li>
<li>Define URL, header, body and content-type</li>
<li>Accept parameters in via GET in the query string</li>
<li>Accept data via a POST request</li>
<li>Setup authentication via basic HTTP auth</li>
<li>Write tests for the above</li>
</ul>
<h2 id="project">Project</h2>
<h3 id="making-an-http-server">Making an HTTP server</h3>
<p><a href="https://go.dev/doc/tutorial/create-module">Create a new go module</a> in this <code>http-auth</code> directory: <code>go mod init http-auth</code>.</p>
<p>Create empty main package <code>main.go</code> and main function. Check it&rsquo;s all working by running the app: <code>go run .</code>.</p>
<p>The main library you&rsquo;ll be working with is built-in to Go: <code>net/http</code>. Import it for use: <code>import &quot;net/http&quot;</code>.</p>
<p>Here&rsquo;s a basic server that we will build from:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Hello, world&#34;</span>))
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Use <code>curl</code> to interact with it: <code>curl -i http://localhost:8080/</code></p>
<p>curl is a tool for transfering data from or to a server. It&rsquo;s very useful for testing and interacting with servers that you build.</p>
<p>Using <code>curl -i</code> will show us how the server responds, including the response &ldquo;headers&rdquo; and &ldquo;body&rdquo;. The headers contain metadata about the response, such as what type of data is being sent back.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Date: Sat, 25 Jun 2022 11:17:17 GMT
</span></span><span style="display:flex;"><span>Content-Length: 25
</span></span><span style="display:flex;"><span>Content-Type: text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hello, world
</span></span></code></pre></div><blockquote>
<p>ðŸ’¡ See the <a href="../prep/README.md#command-line-examples">prep README.md</a> for an explanation of this command line example.</p>
</blockquote>
<p>A common <a href="https://en.m.wikipedia.org/wiki/Communication_protocol">protocol</a> for sending data between clients and servers over the internet is HTTP. It&rsquo;s used for websites, for example.</p>
<p>We can read <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">lots about HTTP here</a>.</p>
<p>HTTP requests are sent from a client to a server. They come in various types such as <code>GET</code>, for reading information, and <code>POST</code> for sending information back.</p>
<p>HTTP responses â€” data sent back to a &ldquo;client&rdquo; from a &ldquo;server&rdquo; as a result of an HTTP request â€” can use a set of <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">standard codes</a> to indicate the status of the server or something about the request.</p>
<h3 id="status-codes">Status codes</h3>
<p>We are going to make a server that responds to <code>GET</code> requests with some of the common ones when a client makes a request to the appropriate URL: 200, 404, 500.</p>
<p>Update our go code so that each of the following paths works. Notice how the URL matches the code that is returned:</p>
<ul>
<li><code>/200</code> -&gt; 200 OK</li>
<li><code>/404</code> -&gt; 404 Not found</li>
<li><code>/500</code> -&gt; 500 Internal Server Error</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/200&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Date: Sat, 25 Jun 2022 11:16:17 GMT
</span></span><span style="display:flex;"><span>Content-Length: 3
</span></span><span style="display:flex;"><span>Content-Type: text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/500&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 500 Internal Server Error
</span></span><span style="display:flex;"><span>Date: Sat, 25 Jun 2022 11:16:30 GMT
</span></span><span style="display:flex;"><span>Content-Length: 21
</span></span><span style="display:flex;"><span>Content-Type: text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Internal server error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/404&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 404 Not Found
</span></span><span style="display:flex;"><span>Content-Type: text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>X-Content-Type-Options: nosniff
</span></span><span style="display:flex;"><span>Date: Sat, 25 Jun 2022 11:17:29 GMT
</span></span><span style="display:flex;"><span>Content-Length: 19
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>404 page not found
</span></span></code></pre></div><p>Use <code>http.NotFoundHandler()</code> for the <code>404</code> error.</p>
<h3 id="the-content-type-header">The Content-Type header</h3>
<p>HTTP requests can return more than just plan text. Next, make the index page at <code>/</code> returns some HTML in response to a <code>GET</code> request. Make sure the <code>Content-Type</code> response header is set: <code>w.Header().Add(&quot;Content-Type&quot;, &quot;text/html&quot;)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 09:42:30 GMT
</span></span><span style="display:flex;"><span>Content-Length: 42
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;em&gt;Hello, world&lt;/em&gt;
</span></span></code></pre></div><p>Curl is just one client we can use to make HTTP requests. Take a moment to try out two more that we&rsquo;ve already used:</p>
<ol>
<li>A web browser - open up http://localhost:8080/ in Chrome.</li>
<li>Postman - make a GET request to http://localhost:8080/ and see the output.</li>
</ol>
<p>All three of these are clients that know how to speak HTTP, but they do different things with the response data because they have different goals.</p>
<p>The goal of the Content-Type header is to tell the client how it may want to render the response to the user. Try changing the Content-Type header back to <code>text/plain</code>, and see what Chrome does with the same response body.</p>
<h3 id="methods-get-and-post">Methods: GET and POST</h3>
<p>Now make the index page accept <code>POST</code> requests with some HTML, and return that HTML. You&rsquo;ll need to check the request method: <code>request.Method</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i -d &#34;&lt;em&gt;Hi&lt;/em&gt;&#34; &#39;http://localhost:8080/&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 09:43:20 GMT
</span></span><span style="display:flex;"><span>Content-Length: 32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;em&gt;Hi&lt;/em&gt;
</span></span></code></pre></div><p>Again, take a look at the response in different clients.</p>
<h3 id="query-parameters">Query parameters</h3>
<p>HTTP requests can also supply &ldquo;query parameters&rdquo; in the URL: <code>/blog-posts?after=2022-05-04</code>. Make the handler at <code>/</code> output the query parameters as a list. Having the output spaced over multiple lines is optional, but done here for readability.</p>
<p>Note that when running commands in a terminal, some characters have special meaning by default, and need escaping - <code>?</code> is one of those characters. We&rsquo;ve been using single-quotes (<code>'</code>s) around all of our URLs because it stops the terminal from making these characters behave specially.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080?foo=bar&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 09:55:33 GMT
</span></span><span style="display:flex;"><span>Content-Length: 96
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;em&gt;Hello, world&lt;/em&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;Query parameters:
</span></span><span style="display:flex;"><span>&lt;ul&gt;
</span></span><span style="display:flex;"><span>&lt;li&gt;foo: [bar]&lt;/li&gt;
</span></span><span style="display:flex;"><span>&lt;/ul&gt;
</span></span></code></pre></div><p>Try putting some HTML into the query params or body. We&rsquo;ll see that it is interpreted as HTML:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080?foo=&lt;strong&gt;bar&lt;/strong&gt;&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 09:57:20 GMT
</span></span><span style="display:flex;"><span>Content-Length: 113
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;em&gt;Hello, world&lt;/em&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;Query parameters:
</span></span><span style="display:flex;"><span>&lt;ul&gt;
</span></span><span style="display:flex;"><span>&lt;li&gt;foo: [&lt;strong&gt;bar&lt;/strong&gt;]&lt;/li&gt;
</span></span><span style="display:flex;"><span>&lt;/ul&gt;
</span></span></code></pre></div><p>(Make sure to take a look at this one in a browser!)</p>
<p>This isn&rsquo;t good! This kind of thing can lead to security issues. Search for &ldquo;XSS attack&rdquo; to find out more. Let&rsquo;s fix it.</p>
<p>&ldquo;Escape&rdquo; the string any time we take some input (data in <code>POST</code> or query parameters) and output it back. We&rsquo;ll need to investigate <code>html.EscapeString(v)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080?foo=&lt;strong&gt;bar&lt;/strong&gt;&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 10:08:08 GMT
</span></span><span style="display:flex;"><span>Content-Length: 125
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;em&gt;Hello, world&lt;/em&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;Query parameters:
</span></span><span style="display:flex;"><span>&lt;ul&gt;
</span></span><span style="display:flex;"><span>&lt;li&gt;foo: [&amp;lt;strong&amp;gt;bar&amp;lt;/strong&amp;gt;]&lt;/li&gt;
</span></span><span style="display:flex;"><span>&lt;/ul&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i -d &#34;&lt;em&gt;Hi&lt;/em&gt;&#34; &#39;http://localhost:8080/&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 10:08:21 GMT
</span></span><span style="display:flex;"><span>Content-Length: 46
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&amp;lt;em&amp;gt;Hi&amp;lt;/em&amp;gt;
</span></span></code></pre></div><p>Take a look at this in a browser too.</p>
<h3 id="authentication">Authentication</h3>
<p>Next we&rsquo;re going to add a URL that can only be accessed if we know a username and secret password.</p>
<p>Add an endpoint <code>/authenticated</code> that requires the use of <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication">HTTP Basic auth</a>. It should return a <code>401 Unauthorized</code> status code with a <code>WWW-Authenticate</code> header if basic auth is not present or does not match a username and password of our choice. Once Basic Auth is provided, it should respond successful!</p>
<p>Go&rsquo;s <code>http</code> library comes with some Basic Auth support built-in, so be sure to use it to make the following work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/authenticated&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 401 Unauthorized
</span></span><span style="display:flex;"><span>Www-Authenticate: Basic realm=&#34;localhost&#34;, charset=&#34;UTF-8&#34;
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 14:12:35 GMT
</span></span><span style="display:flex;"><span>Content-Length: 0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; curl -i &#39;http://localhost:8080/authenticated&#39; -H &#39;Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=&#39;
</span></span><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Sun, 24 Jul 2022 14:13:04 GMT
</span></span><span style="display:flex;"><span>Content-Length: 38
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>Hello username!
</span></span></code></pre></div><p>We can generate the <code>dXNl...</code> text <a href="https://opinionatedgeek.com/Codecs/Base64Encoder">using this website</a>. This is &ldquo;base64 encoded&rdquo; which we can search for to find a bit more about. Enter <code>username:password</code> to get <code>dXNlcm5hbWU6cGFzc3dvcmQ=</code>.</p>
<p>It&rsquo;s not a good idea to put secrets like passwords into code (and base64 encoding text doesn&rsquo;t hide it, it just stores it in a different format). So remove any hard-coded usernames and passwords for basic auth, and use <code>os.Getenv(...)</code> so that this works:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; AUTH_USERNAME=admin AUTH_PASSWORD=long-memorable-password go run .
</span></span></code></pre></div><p>For bonus points, use <a href="https://github.com/joho/godotenv">a library</a> to support dotenv files, and set your AUTH_USERNAME and AUTH_PASSWORD in a <code>.env</code> file.</p>
<h3 id="handling-load">Handling load</h3>
<p>Next we&rsquo;re going to test how many requests your server can support, and add basic <a href="https://www.cloudflare.com/en-gb/learning/bots/what-is-rate-limiting">rate limiting</a>.</p>
<p><a href="https://www.datadoghq.com/blog/apachebench/">Follow this guide</a> to install and use ApacheBench, which will test to see how many requests our server can handle.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; ab -n 10000 -c 100 &#39;http://localhost:8080/&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This is ApacheBench, Version 2.3 &lt;$Revision: 1879490 $&gt;
</span></span><span style="display:flex;"><span>Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style="display:flex;"><span>Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Benchmarking localhost (be patient)
</span></span><span style="display:flex;"><span>Completed 1000 requests
</span></span><span style="display:flex;"><span>Completed 2000 requests
</span></span><span style="display:flex;"><span>Completed 3000 requests
</span></span><span style="display:flex;"><span>Completed 4000 requests
</span></span><span style="display:flex;"><span>Completed 5000 requests
</span></span><span style="display:flex;"><span>Completed 6000 requests
</span></span><span style="display:flex;"><span>Completed 7000 requests
</span></span><span style="display:flex;"><span>Completed 8000 requests
</span></span><span style="display:flex;"><span>Completed 9000 requests
</span></span><span style="display:flex;"><span>Completed 10000 requests
</span></span><span style="display:flex;"><span>Finished 10000 requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server Software:
</span></span><span style="display:flex;"><span>Server Hostname:        localhost
</span></span><span style="display:flex;"><span>Server Port:            8080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Document Path:          /
</span></span><span style="display:flex;"><span>Document Length:        76 bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Concurrency Level:      100
</span></span><span style="display:flex;"><span>Time taken for tests:   0.779 seconds
</span></span><span style="display:flex;"><span>Complete requests:      10000
</span></span><span style="display:flex;"><span>Failed requests:        0
</span></span><span style="display:flex;"><span>Total transferred:      1770000 bytes
</span></span><span style="display:flex;"><span>HTML transferred:       760000 bytes
</span></span><span style="display:flex;"><span>Requests per second:    12837.71 [#/sec] (mean)
</span></span><span style="display:flex;"><span>Time per request:       7.790 [ms] (mean)
</span></span><span style="display:flex;"><span>Time per request:       0.078 [ms] (mean, across all concurrent requests)
</span></span><span style="display:flex;"><span>Transfer rate:          2219.02 [Kbytes/sec] received
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Connection Times (ms)
</span></span><span style="display:flex;"><span>              min  mean[+/-sd] median   max
</span></span><span style="display:flex;"><span>Connect:        0    4   3.2      3      49
</span></span><span style="display:flex;"><span>Processing:     1    4   3.2      4      49
</span></span><span style="display:flex;"><span>Waiting:        0    4   3.1      4      49
</span></span><span style="display:flex;"><span>Total:          5    8   4.5      7      53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Percentage of the requests served within a certain time (ms)
</span></span><span style="display:flex;"><span>  50%      7
</span></span><span style="display:flex;"><span>  66%      8
</span></span><span style="display:flex;"><span>  75%      8
</span></span><span style="display:flex;"><span>  80%      8
</span></span><span style="display:flex;"><span>  90%      8
</span></span><span style="display:flex;"><span>  95%      9
</span></span><span style="display:flex;"><span>  98%     10
</span></span><span style="display:flex;"><span>  99%     11
</span></span><span style="display:flex;"><span> 100%     53 (longest request)
</span></span></code></pre></div><p>If a server receives too many requests at once, it can break (e.g. it may cause the system to run out of memory).</p>
<p>The fact that some of our requests took much longer than others, even though they were doing the same work, suggests that our server was getting stressed. We can see that in the &ldquo;Percentages of the requests served within a certain time&rdquo; section - half of the requests took less than 7ms, but the slowest took 53ms - more than 7 times slower.</p>
<p>It&rsquo;s better to protect your server from being asked to handle too many requests than to have it fall over! So use the <code>rate</code> library to reject excess requests (&gt; X per second) with a <code>503 Service Unavailable</code> error on a <code>/limited</code> endpoint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; go get -u golang.org/x/time
</span></span></code></pre></div><p>We will need to import the module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;golang.org/x/time/rate&#34;</span>
</span></span></code></pre></div><p>Then create a limiter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">limiter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rate</span>.<span style="color:#a6e22e">NewLimiter</span>(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">30</span>)
</span></span></code></pre></div><p>And use it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">limiter</span>.<span style="color:#a6e22e">Allow</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Respond as normal!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Respond with an error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>If it is working, we will see <code>Non-2xx responses</code> and <code>Failed requests</code> in our ApacheBench output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt; ab -n 100 -c 100 &#39;http://localhost:8080/limited&#39;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Document Path:          /limited
</span></span><span style="display:flex;"><span>Document Length:        35 bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Concurrency Level:      100
</span></span><span style="display:flex;"><span>Time taken for tests:   0.006 seconds
</span></span><span style="display:flex;"><span>Complete requests:      100
</span></span><span style="display:flex;"><span>Failed requests:        70 &lt;----- HERE!
</span></span><span style="display:flex;"><span>   (Connect: 0, Receive: 0, Length: 70, Exceptions: 0)
</span></span><span style="display:flex;"><span>Non-2xx responses:      70 &lt;----- HERE!
</span></span><span style="display:flex;"><span>Total transferred:      17170 bytes
</span></span><span style="display:flex;"><span>HTML transferred:       2450 bytes
</span></span><span style="display:flex;"><span>Requests per second:    15544.85 [#/sec] (mean)
</span></span><span style="display:flex;"><span>Time per request:       6.433 [ms] (mean)
</span></span><span style="display:flex;"><span>Time per request:       0.064 [ms] (mean, across all concurrent requests)
</span></span><span style="display:flex;"><span>Transfer rate:          2606.49 [Kbytes/sec] received
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Connection Times (ms)
</span></span><span style="display:flex;"><span>              min  mean[+/-sd] median   max
</span></span><span style="display:flex;"><span>Connect:        0    2   0.7      2       4
</span></span><span style="display:flex;"><span>Processing:     1    1   0.3      1       4
</span></span><span style="display:flex;"><span>Waiting:        0    1   0.2      1       1
</span></span><span style="display:flex;"><span>Total:          2    4   0.7      4       5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Percentage of the requests served within a certain time (ms)
</span></span><span style="display:flex;"><span>  50%      4
</span></span><span style="display:flex;"><span>  66%      4
</span></span><span style="display:flex;"><span>  75%      4
</span></span><span style="display:flex;"><span>  80%      4
</span></span><span style="display:flex;"><span>  90%      5
</span></span><span style="display:flex;"><span>  95%      5
</span></span><span style="display:flex;"><span>  98%      5
</span></span><span style="display:flex;"><span>  99%      5
</span></span><span style="display:flex;"><span> 100%      5 (longest request)
</span></span></code></pre></div><p>Notice that all of our requests took about the same time this time around, and none were much slower - this shows that our server wasn&rsquo;t getting stressed.</p>
<p>One of the things we find in real life is that failure is inevitable. Computers lose power, servers get overloaded and slow down or stop working all together, networks break, etc. Our job as engineers isn&rsquo;t to <em>prevent</em> failure, it&rsquo;s to try to make our systems behave as well as possible <em>depite</em> failure.</p>
<p>In this exercise, we chose to make some of our requests fail fast, so that all of the requests that we <em>did</em> process, got processed well (none were really slow, and our server didn&rsquo;t get overloaded).</p>
<p>Through this course, we learnt a lot more about ways we can give users a better experience by controlling <em>when</em> and <em>how</em> things fail.</p>
</section>

  
<footer class="c-page-footer c-copy">
  <h4 class="c-page-footer__section">
    <a
      class="c-page-footer__section-link e-link"
      href="/projects"
      >projects</a
    >
  </h4>
   
  <nav class="c-page-footer__section-nav">
    <a
      class="e-button e-button--icon c-page-footer__edit"
      href="https://github.com/CodeYourFuture/immersive-go-course/tree/main/projects/http-auth/README.md"
      ><svg
        role="presentation"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="e-button__icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125"
        />
      </svg>
      <span class="is-invisible">Edit this page on GitHub</span></a
    >
    
    
  </nav>
</footer>


</article>


    </main><footer class="l-layout__footer l-footer">
  <a
    class="l-footer__github e-button e-button--icon"
    href="https://github.com/CodeYourFuture/immersive-go-course/"
  >
    <svg
      focusable="false"
      class="e-button__icon"
      role="presentation"
      viewbox="0 0 98 96"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"
        fill="currentColor"
      />
    </svg>
    <span class="is-invisible">Find us on GitHub</span>
  </a>
  <p class="l-footer__impressum e-heading__6">
    This
    <a href="https://github.com/CodeYourFuture/immersive-go-course/"
      >free and open source engineering programme</a
    >
    is a project of
    <a href="https://codeyourfuture.io">Code Your Future</a>
    <br />
    This work is licensed under a Creative Commons Attribution-ShareAlike 4.0
    International License.
  </p>
  <button
    id="mode-toggle"
    class="e__button--toggle e-button--icon l-footer__mode"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="e-icon e__button__icon e-icon--moon"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
      />
    </svg>

    <span class="is-invisible">Toggle between light and dark mode</span>
  </button>
</footer>

  

<script>
  function randomBG() {
    const style = document.createElement("style");
    style.textContent = `body, html {background-image:url("\/pictures/svgs/neons/nnneon.svg"),url("\/pictures/svgs/quads/qqquad-5.svg"),radial-gradient(circle,var(--theme-color--paper) 0%,var(--theme-color--block) 50%,var(--theme-color--paper) 100%);
      background-size: cover;
    }`;

    document.head.appendChild(style);
  }

  window.addEventListener("load", randomBG);
</script>


<script src="/scripts/app.min.js" defer></script>


</div>
</body>
